<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title> Artisan Market</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


<style>
:root{
  --body-bg:#f8f4ec;
  --text-color:#2c1c12;
  --muted-text:#6c5b4f;
  --card-bg:#ffffff;
  --card-shadow:0 12px 25px rgba(0,0,0,0.15);
  --nav-bg:#3e2723;
  --hero-overlay:rgba(0,0,0,0.45);
  --border-color:#e7dbc8;
  --accent:#0d6efd;
}

body{
  background:var(--body-bg);
  color:var(--text-color);
  font-family:"Segoe UI", sans-serif;
  transition:background 0.3s ease,color 0.3s ease;
}

body.dark-mode{
  --body-bg:#101418;
  --text-color:#f6f0e8;
  --muted-text:#b7a295;
  --card-bg:#182027;
  --card-shadow:0 12px 25px rgba(0,0,0,0.55);
  --nav-bg:#0c1117;
  --hero-overlay:rgba(0,0,0,0.65);
  --border-color:#23313f;
  --accent:#66b2ff;
}

.theme-toggle{
  position:fixed;
  top:15px;
  left:15px;
  z-index:100;
}

.theme-toggle button{
  border:none;
  border-radius:20px;
  padding:1px 7px;
  font-weight:600;
  background:var(--card-bg);
  color:var(--text-color);
  box-shadow:0 8px 18px rgba(0,0,0,0.2);
  cursor:pointer;
  display:flex;
  gap:8px;
  align-items:center;
  transition:background 0.3s ease,color 0.3s ease,transform 0.2s ease;
}

.theme-toggle button:hover{
  transform:translateY(-2px);
}

/* Hero */
.hero{
   background:url("https://static.vecteezy.com/system/resources/thumbnails/050/808/847/small/bustling-outdoor-craft-and-artisan-market-of-handmade-products-traditional-artisanal-goods-photo.jpeg") center/cover;
  color:white;
  padding:100px 20px;
  text-align:center;
  position:relative;
  overflow:hidden;
}

.hero::after{
  content:"";
  position:absolute;
  inset:0;
  background:var(--hero-overlay);
}

.hero > *{
  position:relative;
  z-index:2;
}

.hero h1{
  font-size:3rem;
  font-weight:bold;
  text-shadow:2px 2px 6px rgba(0,0,0,0.6);
}

.hero p{
  font-size:1.2rem;
  color:#fef9f3;
}

/* Product Cards */
.card{
  border-radius:15px;
  transition:0.3s;
  background:var(--card-bg);
  border:1px solid var(--border-color);
  box-shadow:var(--card-shadow);
}
.card:hover{
  transform:translateY(-6px);
  box-shadow:0 18px 30px rgba(0,0,0,0.25);
}
.card img{
  height:200px;
  object-fit:cover;
  border-radius:15px 15px 0 0;
}

.card h6,
.card p{
  color:var(--text-color);
}

.card .btn-primary{
  background:var(--accent);
  border:none;
}

/* Cart */
.cart-box{
  background:var(--card-bg);
  border-radius:15px;
  padding:20px;
  box-shadow:var(--card-shadow);
  border:1px solid var(--border-color);
}

.list-group-item{
  background:var(--card-bg);
  color:var(--text-color);
  border-color:var(--border-color);
}

.navbar{
  background:var(--nav-bg) !important;
  transition:background 0.3s ease;
}

.form-control,
.btn,
.list-group-item{
  transition:background 0.3s ease,color 0.3s ease,border 0.3s ease;
}

/* Footer */
.footer-modern{
  background:linear-gradient(120deg,var(--nav-bg),rgba(62,39,35,0.9));
  color:#fdf7f2;
  padding:40px 0 25px;
  margin-top:80px;
}

.footer-modern .footer-brand{
  font-size:1.5rem;
  font-weight:700;
  letter-spacing:0.5px;
}

.footer-modern p{
  color:#f6e7dc;
  margin-bottom:0.4rem;
}

.footer-links a{
  color:#f6e7dc;
  text-decoration:none;
  margin:0 10px;
  font-weight:600;
}
.footer-links a:hover{
  color:#fff;
}

.footer-social button{
  background:rgba(255,255,255,0.15);
  border:none;
  color:#fff;
  width:38px;
  height:38px;
  border-radius:50%;
  margin:0 4px;
  transition:background 0.3s ease;
}
.footer-social button:hover{
  background:rgba(255,255,255,0.35);
}

.footer-divider{
  width:100%;
  height:1px;
  background:rgba(255,255,255,0.2);
  margin:20px 0;
}

.btn i {
  font-size: 22px;
  transition: transform 0.3s, color 0.3s;
}

.btn:hover i {
  transform: scale(1.3);
}

</style>
</head>

<body>

<div class="theme-toggle">
  <button id="themeToggle" type="button">üåû Light</button>
</div>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/">Artisan Market</a>
    <div class="d-flex text-white" id="authBar"></div>
  </div>
</nav>

<!-- HERO -->
<div class="hero">
  <h1> Artisan Market Place</h1>
  <p>Handcrafted with Love ‚Ä¢ Supporting Artisans</p>
</div>

<div id="loginAlert" class="alert alert-warning text-center rounded-0 mb-0" style="display:none;">
  Please login to explore the full marketplace, add products, and support artisans.
  <a href="/login/" class="alert-link">Login</a> or <a href="/register/" class="alert-link">Register</a>
</div>

<!-- PRODUCTS -->
<div class="container my-5">
<h2 class="text-center mb-3">üß∫ Handmade Products</h2>

<div id="addProductSection" class="card p-3 mb-4" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">List a new artisan product</h5>
    <span id="artisanBadge" class="badge bg-success" style="display:none;">Artisan</span>
  </div>
  <p class="text-muted small mb-3" id="productApprovalNote">
    Products added by artisans require admin approval before they appear in the marketplace.
  </p>
  <div class="row g-2">
    <div class="col-md-4">
      <input type="text" class="form-control" id="newName" placeholder="Product name">
    </div>
    <div class="col-md-3">
      <input type="number" step="0.01" class="form-control" id="newPrice" placeholder="Price">
    </div>
    <div class="col-md-4">
      <input type="url" class="form-control" id="newImg" placeholder="Image URL">
    </div>
    <div class="col-md-1 d-grid">
      <button class="btn btn-primary" onclick="addProduct()">Add</button>
    </div>
  </div>
</div>
<div id="nonArtisanNotice" class="alert alert-info" style="display:none;">
  Want to sell your handmade crafts? Register or edit your profile to become a verified artisan. Once approved, your listings will appear after admin review.
</div>

<input type="text" id="searchBox" class="form-control mb-4"
placeholder="Search village products..."
onkeyup="searchProduct()">

<div class="row g-4" id="productList">
  <div class="col-12 text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>
</div>

<!-- CART -->
<div class="container my-5">
<h2 class="text-center mb-4">üõí Your Cart</h2>
<div class="cart-box">
<ul id="cartItems" class="list-group mb-3"></ul>
<h4>Total: ‚Çπ<span id="total">0</span></h4>
<button class="btn btn-success w-100 mt-2" onclick="placeOrder()">Place Order</button>
</div>
</div>

<div class="container my-5">
<h2 class="text-center mb-4">üì¶ Your Orders</h2>
<div class="cart-box">
  <ul id="ordersList" class="list-group mb-3"></ul>
</div>
</div>

<!-- FOOTER -->
<footer class="footer-modern text-center">
  <div class="container">
    <div class="row justify-content-center mb-4">
      <div class="col-lg-6">
        <div class="footer-brand">Pratiphala</div>
        <p>For any queries please contact us at <a href="mailto:bankollermanikanta@gmail.com" style="color:#a62fc8;text-decoration: none;">Pratiphala</a></p>
        
        <div class="footer-links">
          <a href="#productList">Products</a>
          <a href="#ordersList">Orders</a>
          <a href="https://shramajeevi.github.io/Portfolio_website/" style="color:#a62fc8;">Portfolio</a>
    
        </div>
      </div>
    </div>
    <div class="footer-divider"></div>
    <div class="footer-social mb-3">
<div class="d-flex justify-content-center gap-3 mt-3">
  <!-- GitHub -->
  
  <!-- LinkedIn -->
  <a href="https://www.linkedin.com/in/manikant-mahesh-bankoller-490b8b294/" target="_blank" class="btn btn-outline-primary btn-lg">
    <i class="fa-brands fa-linkedin"></i>
  </a>

  <!-- LeetCode -->
  <a href="https://leetcode.com/u/Manikant07/" target="_blank" class="btn btn-outline-warning btn-lg">
    <i class="fa-solid fa-code"></i>
  </a>

   <a href="https://github.com/SHRAMAJEEVI" target="_blank" class="btn btn-outline-dark btn-lg">
    <i class="fa-brands fa-github"></i>
  </a>

    <a href="https://www.youtube.com/@CodeWithPratiphala" target="_blank" class="btn btn-outline-warning btn-lg">
  <i class="fa-brands fa-youtube"></i>
  </a>

   <a href="https://www.instagram.com/_manikant._.7/?igsh=YmhpczcwaDBnaW5v#" target="_blank" class="btn btn-outline-warning btn-lg">
  <i class="fa-brands fa-instagram"></i>
  </a>
</div>


    </div>
    <small>¬© Arise, awake and stop not till the goal is reached...</small>
  </div>
</footer>

<script>
// API base URL
const API_BASE = '/api';
const THEME_KEY = 'vam_theme';

// Generate or retrieve session ID (using localStorage for persistence)
let sessionId = localStorage.getItem('session_id');
if (!sessionId) {
  sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('session_id', sessionId);
}

let products = [];
let cartItems = [];
let filteredProducts = [];
let isAuthenticated = false;
let currentUser = null;
let currentTheme = localStorage.getItem(THEME_KEY) || 'light';
let isArtisan = false;
let isAdmin = false;

function applyTheme(theme){
  const body = document.body;
  const toggleBtn = document.getElementById('themeToggle');
  if(theme === 'dark'){
    body.classList.add('dark-mode');
    toggleBtn.textContent = 'üåú Dark';
  } else {
    body.classList.remove('dark-mode');
    toggleBtn.textContent = 'üåû Light';
  }
}

function toggleTheme(){
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  localStorage.setItem(THEME_KEY, currentTheme);
  applyTheme(currentTheme);
}

document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('themeToggle');
  if(toggleBtn){
    toggleBtn.addEventListener('click', toggleTheme);
  }
  applyTheme(currentTheme);
});

async function fetchAuth(){
  try {
    const r = await fetch(`${API_BASE}/auth/check/`, { credentials: 'same-origin' });
    const d = await r.json();
    isAuthenticated = !!d.authenticated;
    currentUser = d.username || null;
    isArtisan = !!d.is_artisan;
    isAdmin = !!d.is_admin;
  } catch(e){
    isAuthenticated = false;
    currentUser = null;
    isArtisan = false;
    isAdmin = false;
  }
  renderAuthBar();
  toggleAddProductSection();
}

function renderAuthBar(){
  const bar = document.getElementById('authBar');
  if(!bar) return;
  if(isAuthenticated){
    const badges = [];
    if(isAdmin) badges.push('<span class="badge bg-warning text-dark ms-2">Admin</span>');
    else if(isArtisan) badges.push('<span class="badge bg-success ms-2">Artisan</span>');
    bar.innerHTML = `<span class="me-2">Hi, ${currentUser}${badges.join('')}</span><a class="btn btn-outline-light btn-sm" href="/logout/">Logout</a>`;
  } else {
    bar.innerHTML = `<a class="btn btn-outline-light btn-sm me-2" href="/login/">Login</a><a class="btn btn-warning btn-sm" href="/register/">Register</a>`;
  }
}

function toggleAddProductSection(){
  const sec = document.getElementById('addProductSection');
  const badge = document.getElementById('artisanBadge');
  const note = document.getElementById('productApprovalNote');
  const notice = document.getElementById('nonArtisanNotice');
  const loginAlert = document.getElementById('loginAlert');

  if(!sec) return;
  if(!isAuthenticated){
    sec.style.display = 'none';
    if(notice) notice.style.display = 'block';
    if(loginAlert) loginAlert.style.display = 'block';
    return;
  }

  sec.style.display = isArtisan || isAdmin ? 'block' : 'none';
  if(notice) notice.style.display = isArtisan || isAdmin ? 'none' : 'block';
  if(badge) badge.style.display = isArtisan ? 'inline-block' : 'none';
  if(note){
    note.textContent = isAdmin
      ? 'As an admin, your approved products go live immediately.'
      : 'Products added by artisans require admin approval before they appear in the marketplace.';
  }
  if(loginAlert) loginAlert.style.display = 'none';
}

// Load products from backend
async function loadProductsFromBackend() {
  try {
    const response = await fetch(`${API_BASE}/products/`, {
      credentials: 'same-origin',
    });
    products = await response.json();
    filteredProducts = [...products];
    loadProducts(filteredProducts);
    loadCart();
    loadOrders();
  } catch (error) {
    console.error('Error loading products:', error);
    document.getElementById('productList').innerHTML = '<div class="col-12 text-center text-danger">Error loading products. Please refresh the page.</div>';
  }
}

function loadProducts(list){
  const productList = document.getElementById("productList");
  productList.innerHTML = "";

  list.forEach((p)=>{
    const canAdd = isAuthenticated && p.is_approved;
    const loginTooltip = isAuthenticated ? '' : ' title="Login to add items"';
    const pendingTooltip = !p.is_approved ? ' title="Pending admin approval"' : '';
    const addDisabledAttr = canAdd ? '' : 'disabled';
    const showPendingBadge = !p.is_approved ? '<span class="badge bg-warning text-dark ms-2">Pending approval</span>' : '';
    const ownerLabel = p.owner ? `<small class="text-muted d-block">By ${p.owner}</small>` : '';
    const approveButton = (!p.is_approved && isAdmin)
      ? `<button class="btn btn-outline-success btn-sm" onclick="approveProduct(${p.id})">Approve</button>`
      : '';
    const deleteButton = p.owned || isAdmin
      ? `<button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">Delete</button>`
      : '';

    productList.innerHTML += `
    <div class="col-md-3">
      <div class="card h-100">
        <img src="${p.img}" alt="${p.name}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-0">${p.name} ${showPendingBadge}</h6>
              ${ownerLabel}
            </div>
          </div>
          <p class="fw-bold mt-2">‚Çπ${p.price}</p>
          <div class="d-grid gap-2">
            <button class="btn btn-primary btn-sm" ${addDisabledAttr}${loginTooltip || pendingTooltip} onclick="addToCart(${p.id})">
              ${p.is_approved ? 'Add to Cart' : 'Awaiting Approval'}
            </button>
            ${approveButton}
            ${deleteButton}
          </div>
        </div>
      </div>
    </div>`;
  });
}

/* Search */
function searchProduct(){
  const keyword = document.getElementById('searchBox').value.toLowerCase();
  filteredProducts = products.filter(p =>
    p.name.toLowerCase().includes(keyword)
  );
  loadProducts(filteredProducts);
}

async function addProduct(){
  const name = document.getElementById('newName').value.trim();
  const price = document.getElementById('newPrice').value;
  const img = document.getElementById('newImg').value.trim();
  if(!name || !price || !img){
    alert('Please enter name, price and image URL');
    return;
  }
  try{
    const res = await fetch(`${API_BASE}/products/add/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ name, price, img })
    });
    const data = await res.json();
    if(data.success){
      document.getElementById('newName').value='';
      document.getElementById('newPrice').value='';
      document.getElementById('newImg').value='';
      alert(data.message || 'Product submitted for approval');
      loadProductsFromBackend();
    } else {
      alert(data.error || 'Failed to add product');
    }
  } catch(e){
    alert('Failed to add product');
  }
}

async function deleteProduct(productId){
  if(!confirm('Are you sure you want to delete this product?')) return;
  try{
    const res = await fetch(`${API_BASE}/products/delete/${productId}/`, { 
      method: 'DELETE',
      credentials: 'same-origin',
    });
    const data = await res.json();
    if(data.success){
      loadProductsFromBackend();
    } else {
      alert(data.error || "You can't delete this item");
    }
  } catch(e){
    alert("You can't delete this item");
  }
}

async function approveProduct(productId){
  if(!isAdmin){
    alert('Only admins can approve products.');
    return;
  }

  if(!confirm('Approve this artisan product?')) return;
  try{
    const res = await fetch(`${API_BASE}/products/approve/${productId}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
    });
    const data = await res.json();
    if(data.success){
      alert('Product approved.');
      loadProductsFromBackend();
    } else {
      alert(data.error || 'Failed to approve product.');
    }
  } catch(e){
    alert('Failed to approve product.');
  }
}

/* Add to Cart - Backend Integration */
async function addToCart(productId){
  if(!isAuthenticated){
    alert('Please login to add items to your cart.');
    return;
  }
  const product = products.find(p => p.id === productId);
  if(product && !product.is_approved && !isAdmin){
    alert('This item is pending admin approval.');
    return;
  }
  try {
    const response = await fetch(`${API_BASE}/cart/add/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        product_id: productId,
        session_id: sessionId
      })
    });
    
    const data = await response.json();
    if (data.success) {
      loadCart();
    } else {
      alert('Error adding to cart: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error adding to cart:', error);
    alert('Error adding to cart. Please try again.');
  }
}

/* Delete from Cart - Backend Integration */
async function deleteItem(cartItemId){
  try {
    const response = await fetch(`${API_BASE}/cart/remove/${cartItemId}/?session_id=${sessionId}`, {
      method: 'DELETE',
      credentials: 'same-origin',
    });
    
    const data = await response.json();
    if (data.success) {
      loadCart();
    } else {
      alert('Error removing item: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error removing item:', error);
    alert('Error removing item. Please try again.');
  }
}

/* Load Cart from Backend */
async function loadCart() {
  try {
    const response = await fetch(`${API_BASE}/cart/?session_id=${sessionId}`, {
      credentials: 'same-origin',
    });
    const data = await response.json();
    cartItems = data.items || [];
    renderCart(data.total || 0);
  } catch (error) {
    console.error('Error loading cart:', error);
    renderCart(0);
  }
}

/* Render Cart */
function renderCart(total){
  const cartItemsElement = document.getElementById("cartItems");
  cartItemsElement.innerHTML = "";

  if (cartItems.length === 0) {
    cartItemsElement.innerHTML = '<li class="list-group-item text-center text-muted">Your cart is empty</li>';
  } else {
    cartItems.forEach((item)=>{
      cartItemsElement.innerHTML += `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        ${item.name}
        <div>
          <span class="me-2">‚Çπ${item.price}</span>
          <button class="btn btn-danger btn-sm"
          onclick="deleteItem(${item.id})">‚ùå</button>
        </div>
      </li>`;
    });
  }

  document.getElementById("total").innerText = total;
}

/* Place Order - Backend Integration */
async function placeOrder(){
  if(cartItems.length === 0){
    alert("Your cart is empty!");
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/order/place/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        session_id: sessionId
      })
    });
    
    const data = await response.json();
    if (data.success) {
      alert(`Order placed successfully!\nOrder ID: #${data.order_id}\nTotal: ‚Çπ${data.total}\n\nThank you for supporting village artisans.`);
      cartItems = [];
      loadCart();
      loadOrders();
    } else {
      alert('Error placing order: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error placing order:', error);
    alert('Error placing order. Please try again.');
  }
}

async function loadOrders(){
  try{
    const r = await fetch(`${API_BASE}/orders/?session_id=${sessionId}`, {
      credentials: 'same-origin',
    });
    const orders = await r.json();
    const list = document.getElementById('ordersList');
    list.innerHTML = '';
    if(!orders.length){
      list.innerHTML = '<li class="list-group-item text-center text-muted">No orders yet</li>';
      return;
    }
    orders.forEach(o => {
      const items = o.items.map(i => `${i.name} (‚Çπ${i.price})`).join(', ');
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<div><strong>#${o.id}</strong> ¬∑ ‚Çπ${o.total} ¬∑ ${new Date(o.created_at).toLocaleString()}<br><small>${items}</small></div>` + (isAuthenticated ? `<button class="btn btn-outline-danger btn-sm" onclick="deleteOrder(${o.id})">Delete</button>` : '');
      list.appendChild(li);
    });
  } catch(e){
    const list = document.getElementById('ordersList');
    if(list){ list.innerHTML = '<li class="list-group-item text-center text-muted">Failed to load orders</li>'; }
  }
}

async function deleteOrder(orderId){
  if(!confirm('Delete this order?')) return;
  try{
    const r = await fetch(`${API_BASE}/orders/delete/${orderId}/`, { 
      method: 'DELETE',
      credentials: 'same-origin',
    });
    const d = await r.json();
    if(d.success){
      loadOrders();
    } else {
      alert(d.error || 'Failed to delete order');
    }
  } catch(e){
    alert('Failed to delete order');
  }
}

async function init(){
  await fetchAuth();
  await loadProductsFromBackend();
}

init();
</script>

</body>
</html>



